<!-- Admin Books Management View -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <a href="#!/admin" class="btn btn-outline-secondary me-3">
                        <i class="bi bi-arrow-left"></i> Quay lại
                    </a>
                    <h2 class="mb-0"><i class="bi bi-book"></i> Quản lý sách</h2>
                </div>
                <button class="btn btn-primary" ng-click="openCreateModal()">
                    <i class="bi bi-plus-circle"></i> Thêm sách
                </button>
            </div>

            <!-- Loading State -->
            <div ng-if="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-3 text-muted">Đang tải danh sách sách...</p>
            </div>

            <!-- Search and Filter -->
            <div class="row mb-4" ng-if="!loading">
                <div class="col-md-4">
                    <search-box 
                        placeholder="Tìm kiếm sách..." 
                        search-term="searchTerm" 
                        on-search="searchBooks()"
                        on-clear="clearSearch()">
                    </search-box>
                </div>
                <div class="col-md-3">
                    <select class="form-select" ng-model="selectedCategoryId" ng-change="filterByCategory()">
                        <option value="">Tất cả danh mục</option>
                        <option ng-repeat="category in categories" value="{{category.categoryId}}">
                            {{category.name}}
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" ng-model="selectedPublisherId" ng-change="filterByPublisher()">
                        <option value="">Tất cả nhà xuất bản</option>
                        <option ng-repeat="publisher in publishers" value="{{publisher.publisherId}}">
                            {{publisher.name}}
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" ng-click="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>
            </div>


            <!-- Error State -->
            <error-state 
                show="showError" 
                message="errorMessage" 
                dismissible="true">
            </error-state>

            <!-- Success Message -->
            <success-message 
                show="showSuccess" 
                message="successMessage">
            </success-message>

            <!-- Books Table -->
            <div class="card" ng-if="!loading && !showError">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ISBN</th>
                                    <th>Tên sách</th>
                                    <th>Danh mục</th>
                                    <th>Nhà xuất bản</th>
                                    <th>Giá</th>
                                    <th>Số lượng</th>
                                    <th>Năm XB</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="book in books | filter:searchTerm">
                                    <td>
                                        <code>{{book.isbn}}</code>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img ng-if="book.imageUrl" ng-src="{{book.imageUrl}}" alt="{{book.title}}" class="me-2" style="width: 40px; height: 50px; object-fit: cover;">
                                            <i ng-if="!book.imageUrl" class="bi bi-book me-2 text-muted"></i>
                                            <div>
                                                <strong>{{book.title | truncate:30}}</strong><br>
                                                <small class="text-muted">{{book.pageCount}} trang</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{book.categoryName}}</span>
                                    </td>
                                    <td>{{book.publisherName}}</td>
                                    <td>
                                        <strong class="text-primary">{{book.unitPrice | currency}}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{book.stock || 0}}</span>
                                    </td>
                                    <td>{{book.publishYear}}</td>
                                    <td>
                                        <span class="badge"
                                              ng-class="{ 'bg-success': book.status, 'bg-danger': !book.status }">
                                            {{book.status ? 'Đang bán' : 'Ngừng bán'}}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" ng-click="viewBook(book)" title="Xem chi tiết">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" ng-click="openEditModal(book)" title="Chỉnh sửa">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn" ng-class="book.status ? 'btn-outline-secondary' : 'btn-outline-success'" ng-click="toggleBookStatus(book)" title="{{book.status ? 'Tắt sách' : 'Bật sách'}}">
                                                <i class="bi" ng-class="book.status ? 'bi-toggle-off' : 'bi-toggle-on'"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <empty-state 
                show="!loading && !showError && books.length === 0" 
                title="Chưa có sách nào"
                message="Hệ thống chưa có sách nào để hiển thị"
                action-text="Thêm sách đầu tiên"
                action="openCreateModal()">
            </empty-state>

            <!-- Pagination -->
            <pagination 
                current-page="currentPage" 
                total-pages="totalPages" 
                on-page-change="goToPage(page)">
            </pagination>
        </div>
    </div>
</div>

<!-- Create/Edit Book Modal -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-book"></i> {{isEditMode ? 'Chỉnh sửa sách' : 'Thêm sách mới'}}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form name="bookForm" ng-submit="saveBook()" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookIsbn" class="form-label">ISBN <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bookIsbn" name="isbn"
                                       ng-model="bookData.isbn" required
                                       unique-isbn original-isbn="isEditMode ? editingBook.isbn : null"
                                       ng-class="{'is-invalid': bookForm.isbn.$touched && bookForm.isbn.$invalid, 'is-valid': bookForm.isbn.$touched && bookForm.isbn.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.isbn.$touched && bookForm.isbn.$error.required">
                                    Vui lòng nhập ISBN.
                                </div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.isbn.$touched && bookForm.isbn.$error.uniqueIsbn">
                                    ISBN đã tồn tại.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="bookTitle" class="form-label">Tên sách <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bookTitle" name="title" ng-model="bookData.title" required
                                       ng-class="{'is-invalid': bookForm.title.$touched && bookForm.title.$invalid, 'is-valid': bookForm.title.$touched && bookForm.title.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.title.$touched && bookForm.title.$error.required">Vui lòng nhập tên sách.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookCategory" class="form-label">Danh mục <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookCategory" name="category" ng-model="bookData.categoryId" ng-options="(c.categoryId + '') as c.name for c in categories" required
                                        ng-class="{'is-invalid': bookForm.category.$touched && bookForm.category.$invalid, 'is-valid': bookForm.category.$touched && bookForm.category.$valid}">
                                </select>
                                <div class="invalid-feedback d-block" ng-if="bookForm.category.$touched && bookForm.category.$error.required">Vui lòng chọn danh mục.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookPublisher" class="form-label">Nhà xuất bản <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookPublisher" name="publisher" ng-model="bookData.publisherId" ng-options="(p.publisherId + '') as p.name for p in publishers" required
                                        ng-class="{'is-invalid': bookForm.publisher.$touched && bookForm.publisher.$invalid, 'is-valid': bookForm.publisher.$touched && bookForm.publisher.$valid}">
                                </select>
                                <div class="invalid-feedback d-block" ng-if="bookForm.publisher.$touched && bookForm.publisher.$error.required">Vui lòng chọn nhà xuất bản.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookPrice" class="form-label">Giá bán <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookPrice" name="unitPrice" ng-model="bookData.unitPrice" step="0.01" min="0" currency-input required
                                       ng-class="{'is-invalid': bookForm.unitPrice.$touched && bookForm.unitPrice.$invalid, 'is-valid': bookForm.unitPrice.$touched && bookForm.unitPrice.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.unitPrice.$touched && bookForm.unitPrice.$error.required">Vui lòng nhập giá bán.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.unitPrice.$touched && bookForm.unitPrice.$error.min">Giá bán phải lớn hơn 0.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookYear" class="form-label">Năm xuất bản <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookYear" name="publishYear" ng-model="bookData.publishYear" min="1900" max="{{currentYear}}" required
                                       ng-class="{'is-invalid': bookForm.publishYear.$touched && bookForm.publishYear.$invalid, 'is-valid': bookForm.publishYear.$touched && bookForm.publishYear.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.publishYear.$touched && bookForm.publishYear.$error.required">Vui lòng nhập năm xuất bản.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.publishYear.$touched && bookForm.publishYear.$error.min">Năm xuất bản phải từ 1900 trở lên.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.publishYear.$touched && bookForm.publishYear.$error.max">Năm xuất bản không được vượt quá năm hiện tại.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookPages" class="form-label">Số trang <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookPages" name="pageCount" ng-model="bookData.pageCount" min="1" number-input required
                                       ng-class="{'is-invalid': bookForm.pageCount.$touched && bookForm.pageCount.$invalid, 'is-valid': bookForm.pageCount.$touched && bookForm.pageCount.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.pageCount.$touched && bookForm.pageCount.$error.required">Vui lòng nhập số trang.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.pageCount.$touched && bookForm.pageCount.$error.min">Số trang phải lớn hơn 0.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookStock" class="form-label">Số lượng tồn kho</label>
                                <input type="number" class="form-control" id="bookStock" name="stock" ng-model="bookData.stock" min="0" number-input
                                       ng-class="{'is-invalid': bookForm.stock.$touched && bookForm.stock.$invalid, 'is-valid': bookForm.stock.$touched && bookForm.stock.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.stock.$touched && bookForm.stock.$error.min">Số lượng tồn kho không được âm.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookImage" class="form-label">Hình ảnh sách</label>
                                <input type="file" class="form-control" id="bookImage" name="imageFile" 
                                       accept="image/*" ng-model="bookData.imageFile" 
                                       onchange="angular.element(this).scope().previewImage(this)"
                                       file-validation
                                       ng-class="{'is-invalid': bookForm.imageFile.$touched && bookForm.imageFile.$invalid, 'is-valid': bookForm.imageFile.$touched && bookForm.imageFile.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.imageFile.$touched && bookForm.imageFile.$error.fileSize">
                                    File ảnh không được vượt quá 5MB.
                                </div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.imageFile.$touched && bookForm.imageFile.$error.fileType">
                                    Chỉ chấp nhận file ảnh (JPG, PNG, GIF).
                                </div>
                                <div class="mt-2" ng-if="bookData.imagePreview">
                                    <img ng-src="{{bookData.imagePreview}}" alt="Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                    <div class="mt-1">
                                        <button type="button" class="btn btn-sm btn-outline-danger" ng-click="removeImage()">
                                            <i class="bi bi-trash"></i> Xóa ảnh
                                        </button>
                                    </div>
                                </div>
                                <div class="form-text">Chọn file ảnh (JPG, PNG, GIF) - Tối đa 5MB</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="bookAuthors" class="form-label">Tác giả</label>
                                <div class="d-flex gap-2 mb-2">
                                    <select class="form-select" ng-model="selectedAuthorId" ng-change="addAuthor()" ng-options="a.authorId as a.fullName for a in authors track by a.authorId">
                                        <option value="">Chọn tác giả</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" ng-click="addAuthor()" title="Thêm tác giả">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="d-flex flex-wrap gap-1">
                                    <span ng-repeat="author in bookData.authors" class="badge bg-secondary">
                                        {{author.fullName}}
                                        <button type="button" class="btn-close btn-close-white ms-1" ng-click="removeAuthor($index)"></button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary" ng-disabled="bookForm.$invalid || isSaving">
                        <span ng-if="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                        {{isEditMode ? 'Cập nhật' : 'Tạo mới'}}
                    </button>
                </div>
                
                <!-- Form validation summary -->
                <div class="alert alert-warning mt-3" ng-if="bookForm.$submitted && bookForm.$invalid">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Vui lòng kiểm tra lại thông tin:</strong>
                    <ul class="mb-0 mt-2">
                        <li ng-if="bookForm.isbn.$invalid">ISBN không hợp lệ</li>
                        <li ng-if="bookForm.title.$invalid">Tên sách không hợp lệ</li>
                        <li ng-if="bookForm.category.$invalid">Danh mục không hợp lệ</li>
                        <li ng-if="bookForm.publisher.$invalid">Nhà xuất bản không hợp lệ</li>
                        <li ng-if="bookForm.unitPrice.$invalid">Giá bán không hợp lệ</li>
                        <li ng-if="bookForm.publishYear.$invalid">Năm xuất bản không hợp lệ</li>
                        <li ng-if="bookForm.pageCount.$invalid">Số trang không hợp lệ</li>
                        <li ng-if="bookForm.stock.$invalid">Số lượng tồn kho không hợp lệ</li>
                        <li ng-if="bookForm.imageFile.$invalid">File ảnh không hợp lệ</li>
                    </ul>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Book Detail Modal -->
<div class="modal fade" id="bookDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-book"></i> Chi tiết sách
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" ng-if="selectedBook">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <img ng-if="selectedBook.imageUrl || selectedBook.imagePreview" 
                                 ng-src="{{selectedBook.imagePreview || selectedBook.imageUrl}}" 
                                 alt="{{selectedBook.title}}" class="img-fluid rounded">
                            <i ng-if="!selectedBook.imageUrl && !selectedBook.imagePreview" class="bi bi-book display-1 text-muted"></i>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h4>{{selectedBook.title}}</h4>
                        <p class="text-muted">ISBN: {{selectedBook.isbn}}</p>
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <strong>Danh mục:</strong><br>
                                <span class="badge bg-primary">{{selectedBook.categoryName}}</span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Nhà xuất bản:</strong><br>
                                {{selectedBook.publisherName}}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <strong>Năm xuất bản:</strong><br>
                                {{selectedBook.publishYear}}
                            </div>
                            <div class="col-sm-6">
                                <strong>Số trang:</strong><br>
                                {{selectedBook.pageCount}} trang
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <strong>Giá bán:</strong><br>
                                <span class="h5 text-primary">{{selectedBook.unitPrice | currency}}</span>
                            </div>
                        </div>
                        
                        <div ng-if="selectedBook.authors && selectedBook.authors.length > 0">
                            <strong>Tác giả:</strong><br>
                            <div ng-repeat="author in selectedBook.authors">
                                <span class="badge bg-secondary me-1">{{author.fullName}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" ng-click="openEditModal(selectedBook)">
                    <i class="bi bi-pencil"></i> Chỉnh sửa
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<confirm-dialog 
    show="showDeleteConfirm" 
    title="Xác nhận xóa sách"
    message="Bạn có chắc chắn muốn xóa sách '{{bookToDelete.title}}'? Hành động này không thể hoàn tác."
    on-confirm="deleteBook()">
</confirm-dialog>

<!-- Toasts -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2000;">
    <div class="toast align-items-center text-white bg-{{t.variant}} border-0 mb-2 show" role="alert" aria-live="assertive" aria-atomic="true" ng-repeat="t in toasts">
        <div class="d-flex">
            <div class="toast-body">{{t.message}}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" ng-click="toasts.splice($index,1)"></button>
        </div>
    </div>
    </div>

<style>
    /* Normalize control heights in book modal */
    #bookModal .form-control,
    #bookModal .form-select {
        height: 38px;
        padding: 0.375rem 0.75rem;
        line-height: 1.5;
        border-radius: 0.375rem;
    }
    #bookModal .form-label { margin-bottom: 0.25rem; }
    #bookModal .row > [class*='col-'] { margin-bottom: 0.5rem; }
    /* Ensure equal spacing between two columns */
    #bookModal .row.g-3 { row-gap: 0.75rem; }
    
    /* File input styling */
    #bookModal input[type="file"] {
        height: auto;
        padding: 0.375rem 0.75rem;
    }
    
    /* Image preview styling */
    .img-thumbnail {
        border: 2px solid #dee2e6;
        border-radius: 0.375rem;
        object-fit: cover;
    }
    
    /* File validation styling */
    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .form-control.is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    .form-select.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .form-select.is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    /* Validation summary styling */
    .alert-warning {
        border-left: 4px solid #ffc107;
    }
    
    .alert-warning ul {
        padding-left: 1.5rem;
    }
    
    .alert-warning li {
        margin-bottom: 0.25rem;
    }
</style>
