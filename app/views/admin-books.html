<!-- Directives are globally loaded in index.html (removed per-view includes) -->

<!-- Admin Books Management View -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <a href="#!/admin" class="btn btn-outline-secondary me-3">
                        <i class="bi bi-arrow-left"></i> Quay lại
                    </a>
                    <h2 class="mb-0"><i class="bi bi-book"></i> Quản lý sách</h2>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" type="button" ng-click="openPublisherManager()">
                        <i class="bi bi-buildings"></i> Quản lý NXB
                    </button>
                    <button class="btn btn-primary" ng-click="openCreateModal()">
                        <i class="bi bi-plus-circle"></i> Thêm sách
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div ng-if="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-3 text-muted">Đang tải danh sách sách...</p>
            </div>

            <!-- Search and Filter -->
            <div class="row mb-4" ng-if="!loading">
                <div class="col-md-4">
                    <search-box 
                        placeholder="Tìm kiếm sách..." 
                        search-term="searchTerm" 
                        on-search="searchBooks()"
                        on-clear="clearSearch()">
                    </search-box>
                </div>
                <div class="col-md-3">
                    <select class="form-select" ng-model="selectedCategoryId" ng-change="filterByCategory()">
                        <option value="">Tất cả danh mục</option>
                        <option ng-repeat="category in categories" value="{{category.categoryId}}">
                            {{category.name}}
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" ng-model="selectedPublisherId" ng-change="filterByPublisher()">
                        <option value="">Tất cả nhà xuất bản</option>
                        <option ng-repeat="publisher in publishers" value="{{publisher.publisherId}}">
                            {{publisher.name}}
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" ng-click="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Active filters + summary -->
            <div class="d-flex align-items-center justify-content-between mb-2" ng-if="!loading">
                <div class="small text-muted">
                    Đang hiển thị: <strong>{{(books||[]).length}}</strong> sách
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge rounded-pill bg-light text-dark border" ng-if="searchTerm">
                        Từ khóa: "{{searchTerm}}"
                        <button type="button" class="btn-close btn-close-white ms-1" ng-click="clearSearch()"></button>
                    </span>
                    <span class="badge rounded-pill bg-light text-dark border" ng-if="selectedCategoryId">
                        Danh mục: {{(categories | filter:{categoryId:selectedCategoryId})[0].name || selectedCategoryId}}
                        <button type="button" class="btn-close btn-close-white ms-1" ng-click="selectedCategoryId=''; filterByCategory()"></button>
                    </span>
                    <span class="badge rounded-pill bg-light text-dark border" ng-if="selectedPublisherId">
                        NXB: {{(publishers | filter:{publisherId:selectedPublisherId})[0].name || selectedPublisherId}}
                        <button type="button" class="btn-close btn-close-white ms-1" ng-click="selectedPublisherId=''; filterByPublisher()"></button>
                    </span>
                </div>
            </div>


            <!-- Error State -->
            <div class="alert alert-danger alert-dismissible fade show" ng-if="showError" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Lỗi:</strong> {{errorMessage}}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" ng-click="clearError()"></button>
            </div>


            <!-- Books Table -->
            <div class="card" ng-if="!loading && !showError">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ISBN</th>
                                    <th>Tên sách</th>
                                    <th>Danh mục</th>
                                    <th>Nhà xuất bản</th>
                                    <th>Giá</th>
                                    <th>Số lượng</th>
                                    <th>Năm XB</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="book in books track by book.isbn">
                                    <td>
                                        <code>{{book.isbn}}</code>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img ng-if="book.imageUrl" ng-src="{{book.imageUrl}}" alt="{{book.title}}" class="me-2" style="width: 40px; height: 50px; object-fit: cover;">
                                            <i ng-if="!book.imageUrl" class="bi bi-book me-2 text-muted"></i>
                                            <div>
                                                <strong>{{truncate(book.title, 30)}}</strong><br>
                                                <small class="text-muted">{{book.pageCount}} trang</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{book.categoryName}}</span>
                                    </td>
                                    <td>{{book.publisherName}}</td>
                                    <td>
                                        <div ng-if="book.discountedPrice && book.discountedPrice !== book.currentPrice">
                                            <span class="text-decoration-line-through text-muted">{{book.currentPrice | number}} ₫</span><br>
                                            <strong class="text-danger">{{book.discountedPrice | number}} ₫</strong>
                                        </div>
                                        <div ng-if="!book.discountedPrice || book.discountedPrice === book.currentPrice">
                                            <strong class="text-primary">{{book.currentPrice | number}} ₫</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{book.stock || 0}}</span>
                                    </td>
                                    <td>{{book.publishYear}}</td>
                                    <td>
                                        <span class="badge"
                                              ng-class="{ 'bg-success': book.status, 'bg-danger': !book.status }">
                                            {{book.status ? 'Đang bán' : 'Ngừng bán'}}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" ng-click="viewBook(book)" title="Xem chi tiết">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" ng-click="openEditModal(book)" title="Chỉnh sửa">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" ng-click="openPriceChangeModal(book)" title="Thay đổi giá">
                                                <i class="bi bi-cash-coin"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" ng-click="viewPriceHistory(book)" title="Lịch sử giá">
                                                <i class="bi bi-clock-history"></i>
                                            </button>
                                            <button class="btn" ng-class="book.status ? 'btn-outline-secondary' : 'btn-outline-success'" ng-click="toggleBookStatus(book)" title="{{book.status ? 'Tắt sách' : 'Bật sách'}}">
                                                <i class="bi" ng-class="book.status ? 'bi-toggle-off' : 'bi-toggle-on'"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <empty-state 
                show="!loading && !showError && books.length === 0" 
                title="Chưa có sách nào"
                message="Hệ thống chưa có sách nào để hiển thị"
                action-text="Thêm sách đầu tiên"
                action="openCreateModal()">
            </empty-state>

            <!-- Pagination -->
            <pagination 
                current-page="currentPage" 
                total-pages="totalPages" 
                on-page-change="goToPage(page)">
            </pagination>
        </div>
    </div>
</div>

<!-- Publisher management modal -->
<div class="modal fade" id="publisherModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-buildings"></i> Quản lý nhà xuất bản
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-lg-7 border-end">
                        <div class="d-flex gap-2 mb-3">
                            <input type="text" class="form-control" placeholder="Tìm kiếm nhà xuất bản..."
                                   ng-model="publisherManager.searchTerm"
                                   ng-keypress="$event.which === 13 && searchPublisherManager()">
                            <button type="button" class="btn btn-outline-secondary" ng-click="searchPublisherManager()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div class="table-responsive position-relative">
                            <div class="text-center py-4" ng-if="publisherManager.loading">
                                <div class="spinner-border text-primary"></div>
                                <div class="mt-2 text-muted">Đang tải danh sách nhà xuất bản...</div>
                            </div>
                            <table class="table table-sm align-middle" ng-if="!publisherManager.loading && publisherManager.items.length">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 32%">Tên</th>
                                        <th style="width: 18%">Email</th>
                                        <th style="width: 14%">Điện thoại</th>
                                        <th style="width: 22%">Địa chỉ</th>
                                        <th style="width: 8%">Sách</th>
                                        <th style="width: 6%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="pub in publisherManager.items">
                                        <td>
                                            <div class="fw-semibold">{{pub.name}}</div>
                                            <div class="text-muted small" ng-if="pub.publisherId">#{{pub.publisherId}}</div>
                                        </td>
                                        <td>
                                            <a ng-if="pub.email" ng-href="mailto:{{pub.email}}">{{pub.email}}</a>
                                            <span ng-if="!pub.email">—</span>
                                        </td>
                                        <td>{{pub.phone || '—'}}</td>
                                        <td>
                                            <span class="text-truncate d-inline-block" style="max-width: 180px;" title="{{pub.address}}">
                                                {{pub.address || '—'}}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary-subtle text-secondary-emphasis">
                                                {{pub.bookCount || 0}}
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" type="button"
                                                        ng-click="editPublisher(pub, publisherForm)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" type="button"
                                                        ng-disabled="publisherManager.deletingId === pub.publisherId"
                                                        ng-click="confirmDeletePublisher(pub)">
                                                    <span ng-if="publisherManager.deletingId === pub.publisherId" class="spinner-border spinner-border-sm"></span>
                                                    <i ng-if="publisherManager.deletingId !== pub.publisherId" class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="text-center py-4 text-muted" ng-if="!publisherManager.loading && !publisherManager.items.length">
                                <i class="bi bi-inboxes display-6 d-block mb-2"></i>
                                Chưa có nhà xuất bản nào.
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3" ng-if="publisherManager.totalPages > 1">
                            <div class="small text-muted">
                                Tổng: {{publisherManager.totalCount}} nhà xuất bản
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" type="button"
                                        ng-disabled="publisherManager.pageNumber === 1"
                                        ng-click="changePublisherManagerPage(publisherManager.pageNumber - 1)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="btn btn-outline-secondary disabled">
                                    Trang {{publisherManager.pageNumber}} / {{publisherManager.totalPages}}
                                </span>
                                <button class="btn btn-outline-secondary" type="button"
                                        ng-disabled="publisherManager.pageNumber === publisherManager.totalPages"
                                        ng-click="changePublisherManagerPage(publisherManager.pageNumber + 1)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>{{publisherManager.isEdit ? 'Chỉnh sửa nhà xuất bản' : 'Thêm nhà xuất bản mới'}}</span>
                                <span class="badge bg-light text-dark" ng-if="publisherManager.isEdit">Đang chỉnh sửa</span>
                            </div>
                            <div class="card-body">
                                <form name="publisherForm" novalidate ng-submit="submitPublisherForm(publisherForm)">
                                    <div class="mb-3">
                                        <label class="form-label">Tên nhà xuất bản <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control"
                                               ng-model="publisherFormData.name"
                                               maxlength="150" required
                                               ng-class="{'is-invalid': publisherForm.$submitted && !publisherFormData.name}">
                                        <div class="invalid-feedback d-block" ng-if="publisherForm.$submitted && !publisherFormData.name">
                                            Vui lòng nhập tên nhà xuất bản.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control"
                                               ng-model="publisherFormData.email"
                                               maxlength="191" required
                                               ng-class="{'is-invalid': publisherForm.$submitted && !publisherFormData.email}">
                                        <div class="invalid-feedback d-block" ng-if="publisherForm.$submitted && !publisherFormData.email">
                                            Vui lòng nhập email hợp lệ.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control"
                                               ng-model="publisherFormData.phone"
                                               maxlength="20" required
                                               ng-class="{'is-invalid': publisherForm.$submitted && !publisherFormData.phone}">
                                        <div class="invalid-feedback d-block" ng-if="publisherForm.$submitted && !publisherFormData.phone">
                                            Vui lòng nhập số điện thoại.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Địa chỉ <span class="text-danger">*</span></label>
                                        <textarea class="form-control" rows="3"
                                                  ng-model="publisherFormData.address"
                                                  maxlength="500" required
                                                  ng-class="{'is-invalid': publisherForm.$submitted && !publisherFormData.address}"></textarea>
                                        <div class="invalid-feedback d-block" ng-if="publisherForm.$submitted && !publisherFormData.address">
                                            Vui lòng nhập địa chỉ.
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary flex-grow-1" ng-disabled="publisherManager.saving">
                                            <span ng-if="publisherManager.saving" class="spinner-border spinner-border-sm me-1"></span>
                                            {{publisherManager.isEdit ? 'Cập nhật' : 'Thêm mới'}}
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" ng-click="startCreatePublisher(publisherForm)" ng-disabled="publisherManager.saving">
                                            <i class="bi bi-arrow-counterclockwise"></i> Làm mới
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0" ng-if="publisherManager.isEdit && publisherFormData.bookCount > 0">
                            <i class="bi bi-info-circle"></i>
                            NXB đang liên kết {{publisherFormData.bookCount}} sách. Xóa NXB sẽ ảnh hưởng tới dữ liệu sách liên quan.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Book Modal -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-book"></i> {{isEditMode ? 'Chỉnh sửa sách' : 'Thêm sách mới'}}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form name="bookForm" ng-submit="saveBook()" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookIsbn" class="form-label">ISBN <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bookIsbn" name="isbn"
                                       ng-model="bookData.isbn" required
                                       unique-isbn original-isbn="isEditMode ? editingBook.isbn : null"
                                       ng-change="onIsbnChange()"
                                       ng-class="{'is-invalid': bookForm.isbn.$touched && bookForm.isbn.$invalid, 'is-valid': bookForm.isbn.$touched && bookForm.isbn.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.isbn.$touched && bookForm.isbn.$error.required">
                                    Vui lòng nhập ISBN.
                                </div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.isbn.$touched && bookForm.isbn.$error.uniqueIsbn">
                                    ISBN đã tồn tại.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="bookTitle" class="form-label">Tên sách <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bookTitle" name="title" ng-model="bookData.title" required
                                       ng-class="{'is-invalid': bookForm.title.$touched && bookForm.title.$invalid, 'is-valid': bookForm.title.$touched && bookForm.title.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.title.$touched && bookForm.title.$error.required">Vui lòng nhập tên sách.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookCategory" class="form-label">Danh mục <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookCategory" name="category" ng-model="bookData.categoryId" ng-options="(c.categoryId + '') as c.name for c in categories" required
                                        ng-class="{'is-invalid': bookForm.category.$touched && bookForm.category.$invalid, 'is-valid': bookForm.category.$touched && bookForm.category.$valid}">
                                </select>
                                <div class="invalid-feedback d-block" ng-if="bookForm.category.$touched && bookForm.category.$error.required">Vui lòng chọn danh mục.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookPublisher" class="form-label">Nhà xuất bản <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookPublisher" name="publisher" ng-model="bookData.publisherId" ng-options="(p.publisherId + '') as p.name for p in publishers" required
                                        ng-class="{'is-invalid': bookForm.publisher.$touched && bookForm.publisher.$invalid, 'is-valid': bookForm.publisher.$touched && bookForm.publisher.$valid}">
                                </select>
                                <div class="invalid-feedback d-block" ng-if="bookForm.publisher.$touched && bookForm.publisher.$error.required">Vui lòng chọn nhà xuất bản.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookPrice" class="form-label">Giá hiện tại <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookPrice" name="currentPrice" ng-model="bookData.currentPrice" step="0.01" min="0" required
                                       placeholder="Nhập giá bằng VNĐ"
                                       ng-disabled="isEditMode"
                                       ng-class="{'is-invalid': bookForm.currentPrice.$touched && bookForm.currentPrice.$invalid, 'is-valid': bookForm.currentPrice.$touched && bookForm.currentPrice.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.currentPrice.$touched && bookForm.currentPrice.$error.required">Vui lòng nhập giá hiện tại.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.currentPrice.$touched && bookForm.currentPrice.$error.min">Giá hiện tại phải lớn hơn 0.</div>
                                <div class="form-text" ng-if="!isEditMode">Nhập giá bằng VNĐ (ví dụ: 50000)</div>
                                <div class="form-text text-muted" ng-if="isEditMode">
                                    <i class="bi bi-info-circle"></i> 
                                    Để thay đổi giá, sử dụng nút <i class="bi bi-cash-coin"></i> "Thay đổi giá" trong bảng danh sách sách.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="bookYear" class="form-label">Năm xuất bản <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookYear" name="publishYear" ng-model="bookData.publishYear" min="1900" max="{{currentYear}}" required
                                       ng-class="{'is-invalid': bookForm.publishYear.$touched && bookForm.publishYear.$invalid, 'is-valid': bookForm.publishYear.$touched && bookForm.publishYear.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.publishYear.$touched && bookForm.publishYear.$error.required">Vui lòng nhập năm xuất bản.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.publishYear.$touched && bookForm.publishYear.$error.min">Năm xuất bản phải từ 1900 trở lên.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.publishYear.$touched && bookForm.publishYear.$error.max">Năm xuất bản không được vượt quá năm hiện tại.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookPages" class="form-label">Số trang <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookPages" name="pageCount" ng-model="bookData.pageCount" min="1" number-input required
                                       ng-class="{'is-invalid': bookForm.pageCount.$touched && bookForm.pageCount.$invalid, 'is-valid': bookForm.pageCount.$touched && bookForm.pageCount.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.pageCount.$touched && bookForm.pageCount.$error.required">Vui lòng nhập số trang.</div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.pageCount.$touched && bookForm.pageCount.$error.min">Số trang phải lớn hơn 0.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookStock" class="form-label">Số lượng tồn kho</label>
                                <input type="number" class="form-control" id="bookStock" name="stock" ng-model="bookData.stock" min="0" number-input
                                       ng-class="{'is-invalid': bookForm.stock.$touched && bookForm.stock.$invalid, 'is-valid': bookForm.stock.$touched && bookForm.stock.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.stock.$touched && bookForm.stock.$error.min">Số lượng tồn kho không được âm.</div>
                            </div>
                            <div class="mb-3">
                                <label for="bookImage" class="form-label">Hình ảnh sách</label>
                                <input type="file" class="form-control" id="bookImage" name="imageFile" 
                                       accept="image/*" ng-model="bookData.imageFile" 
                                       onchange="angular.element(this).scope().previewImage(this)"
                                       file-validation
                                       ng-class="{'is-invalid': bookForm.imageFile.$touched && bookForm.imageFile.$invalid, 'is-valid': bookForm.imageFile.$touched && bookForm.imageFile.$valid}">
                                <div class="invalid-feedback d-block" ng-if="bookForm.imageFile.$touched && bookForm.imageFile.$error.fileSize">
                                    File ảnh không được vượt quá 5MB.
                                </div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.imageFile.$touched && bookForm.imageFile.$error.fileType">
                                    Chỉ chấp nhận file ảnh (JPG, PNG, GIF).
                                </div>
                                <div class="mt-2" ng-if="bookData.imagePreview">
                                    <img ng-src="{{bookData.imagePreview}}" alt="Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                    <div class="mt-1">
                                        <button type="button" class="btn btn-sm btn-outline-danger" ng-click="removeImage()">
                                            <i class="bi bi-trash"></i> Xóa ảnh
                                        </button>
                                    </div>
                                </div>
                                <div class="form-text">Chọn file ảnh (JPG, PNG, GIF) - Tối đa 5MB</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="bookAuthors" class="form-label">Tác giả <span class="text-danger">*</span></label>
                                <div class="d-flex gap-2 mb-2">
                                    <select class="form-select" ng-model="selectedAuthorId" ng-change="addAuthor()" ng-options="a.authorId as a.fullName for a in authors track by a.authorId">
                                        <option value="">Chọn tác giả</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" ng-click="addAuthor()" title="Thêm tác giả">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="d-flex flex-wrap gap-1" ng-class="{'is-invalid': bookForm.$submitted && bookData.authors.length === 0}">
                                    <span ng-repeat="author in bookData.authors" class="badge bg-secondary">
                                        {{author.fullName}}
                                        <button type="button" class="btn-close btn-close-white ms-1" ng-click="removeAuthor($index)"></button>
                                    </span>
                                </div>
                                <div class="invalid-feedback d-block" ng-if="bookForm.$submitted && bookData.authors.length === 0">
                                    Vui lòng thêm ít nhất một tác giả.
                                </div>
                                <div class="form-text">Chọn và thêm tác giả cho sách</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary" ng-disabled="bookForm.$invalid || isSaving || bookData.authors.length === 0">
                        <span ng-if="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                        {{isEditMode ? 'Cập nhật' : 'Tạo mới'}}
                    </button>
                </div>
                
                <!-- Form validation summary -->
                <div class="alert alert-warning mt-3" ng-if="bookForm.$submitted && (bookForm.$invalid || bookData.authors.length === 0)">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Vui lòng kiểm tra lại thông tin:</strong>
                    <ul class="mb-0 mt-2">
                        <li ng-if="bookForm.isbn.$invalid">ISBN không hợp lệ</li>
                        <li ng-if="bookForm.title.$invalid">Tên sách không hợp lệ</li>
                        <li ng-if="bookForm.category.$invalid">Danh mục không hợp lệ</li>
                        <li ng-if="bookForm.publisher.$invalid">Nhà xuất bản không hợp lệ</li>
                        <li ng-if="bookForm.currentPrice.$invalid">Giá hiện tại không hợp lệ</li>
                        <li ng-if="bookForm.publishYear.$invalid">Năm xuất bản không hợp lệ</li>
                        <li ng-if="bookForm.pageCount.$invalid">Số trang không hợp lệ</li>
                        <li ng-if="bookForm.stock.$invalid">Số lượng tồn kho không hợp lệ</li>
                        <li ng-if="bookForm.imageFile.$invalid">File ảnh không hợp lệ</li>
                        <li ng-if="bookData.authors.length === 0">Chưa có tác giả nào</li>
                    </ul>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Book Detail Modal -->
<div class="modal fade" id="bookDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-book"></i> Chi tiết sách
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" ng-if="selectedBook">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <img ng-if="selectedBook.imageUrl || selectedBook.imagePreview" 
                                 ng-src="{{selectedBook.imagePreview || selectedBook.imageUrl}}" 
                                 alt="{{selectedBook.title}}" class="img-fluid rounded">
                            <i ng-if="!selectedBook.imageUrl && !selectedBook.imagePreview" class="bi bi-book display-1 text-muted"></i>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h4>{{selectedBook.title}}</h4>
                        <p class="text-muted">ISBN: {{selectedBook.isbn}}</p>
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <strong>Danh mục:</strong><br>
                                <span class="badge bg-primary">{{selectedBook.categoryName}}</span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Nhà xuất bản:</strong><br>
                                {{selectedBook.publisherName}}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <strong>Năm xuất bản:</strong><br>
                                {{selectedBook.publishYear}}
                            </div>
                            <div class="col-sm-6">
                                <strong>Số trang:</strong><br>
                                {{selectedBook.pageCount}} trang
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <strong>Giá hiện tại:</strong><br>
                                <span class="h5 text-primary">{{selectedBook.currentPrice | number}} ₫</span>
                            </div>
                        </div>
                        
                        <div ng-if="selectedBook.authors && selectedBook.authors.length > 0">
                            <strong>Tác giả:</strong><br>
                            <div ng-repeat="author in selectedBook.authors">
                                <span class="badge bg-secondary me-1">{{author.fullName}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" ng-click="openEditModal(selectedBook)">
                    <i class="bi bi-pencil"></i> Chỉnh sửa
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<confirm-dialog 
    show="showDeleteConfirm" 
    title="Xác nhận xóa sách"
    message="Bạn có chắc chắn muốn xóa sách '{{bookToDelete.title}}'? Hành động này không thể hoàn tác."
    on-confirm="deleteBook()">
</confirm-dialog>

<!-- Toasts -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2000;">
    <div class="toast align-items-center text-white bg-{{t.variant}} border-0 mb-2 show" role="alert" aria-live="assertive" aria-atomic="true" ng-repeat="t in toasts">
        <div class="d-flex">
            <div class="toast-body">{{t.message}}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" ng-click="toasts.splice($index,1)"></button>
        </div>
    </div>
    </div>

<style>
    /* Normalize control heights in book modal */
    #bookModal .form-control,
    #bookModal .form-select {
        height: 38px;
        padding: 0.375rem 0.75rem;
        line-height: 1.5;
        border-radius: 0.375rem;
    }
    #bookModal .form-label { margin-bottom: 0.25rem; }
    #bookModal .row > [class*='col-'] { margin-bottom: 0.5rem; }
    /* Ensure equal spacing between two columns */
    #bookModal .row.g-3 { row-gap: 0.75rem; }
    
    /* File input styling */
    #bookModal input[type="file"] {
        height: auto;
        padding: 0.375rem 0.75rem;
    }
    
    /* Image preview styling */
    .img-thumbnail {
        border: 2px solid #dee2e6;
        border-radius: 0.375rem;
        object-fit: cover;
    }
    
    /* File validation styling */
    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .form-control.is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    .form-select.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .form-select.is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    /* Validation summary styling */
    .alert-warning {
        border-left: 4px solid #ffc107;
    }
    
    .alert-warning ul {
        padding-left: 1.5rem;
    }
    
    .alert-warning li {
        margin-bottom: 0.25rem;
    }
</style>

<!-- Price Change Modal -->
<div class="modal fade" id="priceChangeModal" tabindex="-1" aria-labelledby="priceChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceChangeModalLabel">
                    <i class="bi bi-cash-coin"></i> Thay đổi giá sách
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Sách:</strong><br>
                        <span class="h6">{{selectedBookForPriceChange.title}}</span><br>
                        <small class="text-muted">ISBN: {{selectedBookForPriceChange.isbn}}</small>
                    </div>
                    <div class="col-md-6">
                        <strong>Giá hiện tại:</strong><br>
                        <span class="h5 text-primary">{{selectedBookForPriceChange.currentPrice | number}} ₫</span>
                    </div>
                </div>
                
                <form name="priceChangeForm" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newPrice" class="form-label">Giá mới <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="newPrice" name="newPrice" 
                                       ng-model="priceChangeData.newPrice" step="0.01" min="0" required
                                       ng-class="{'is-invalid': priceChangeForm.newPrice.$touched && priceChangeForm.newPrice.$invalid, 'is-valid': priceChangeForm.newPrice.$touched && priceChangeForm.newPrice.$valid}">
                                <div class="invalid-feedback d-block" ng-if="priceChangeForm.newPrice.$touched && priceChangeForm.newPrice.$error.required">Vui lòng nhập giá mới.</div>
                                <div class="invalid-feedback d-block" ng-if="priceChangeForm.newPrice.$touched && priceChangeForm.newPrice.$error.min">Giá mới phải lớn hơn 0.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="effectiveDate" class="form-label">Ngày hiệu lực <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="effectiveDate" name="effectiveDate" 
                                       ng-model="priceChangeData.effectiveDate" required
                                       ng-class="{'is-invalid': priceChangeForm.effectiveDate.$touched && priceChangeForm.effectiveDate.$invalid, 'is-valid': priceChangeForm.effectiveDate.$touched && priceChangeForm.effectiveDate.$valid}">
                                <div class="invalid-feedback d-block" ng-if="priceChangeForm.effectiveDate.$touched && priceChangeForm.effectiveDate.$error.required">Vui lòng chọn ngày hiệu lực.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Lý do thay đổi <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" 
                                  ng-model="priceChangeData.reason" maxlength="500" required
                                  ng-class="{'is-invalid': priceChangeForm.reason.$touched && priceChangeForm.reason.$invalid, 'is-valid': priceChangeForm.reason.$touched && priceChangeForm.reason.$valid}"
                                  placeholder="Nhập lý do thay đổi giá..."></textarea>
                        <div class="invalid-feedback d-block" ng-if="priceChangeForm.reason.$touched && priceChangeForm.reason.$error.required">Vui lòng nhập lý do thay đổi.</div>
                        <div class="form-text">{{priceChangeData.reason ? priceChangeData.reason.length : 0}}/500 ký tự</div>
                    </div>
                    
                    <!-- Price comparison -->
                    <div class="alert alert-info" ng-if="priceChangeData.newPrice && selectedBookForPriceChange.currentPrice">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Giá cũ:</strong> {{selectedBookForPriceChange.currentPrice | number}} ₫
                            </div>
                            <div class="col-md-6">
                                <strong>Giá mới:</strong> {{priceChangeData.newPrice | number}} ₫
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Thay đổi:</strong> 
                            <span ng-class="{'text-success': priceChangeData.newPrice > selectedBookForPriceChange.currentPrice, 'text-danger': priceChangeData.newPrice < selectedBookForPriceChange.currentPrice, 'text-muted': priceChangeData.newPrice == selectedBookForPriceChange.currentPrice}">
                                {{((priceChangeData.newPrice - selectedBookForPriceChange.currentPrice) / selectedBookForPriceChange.currentPrice * 100) | number:1}}%
                                ({{priceChangeData.newPrice - selectedBookForPriceChange.currentPrice | number}} ₫)
                            </span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" ng-click="savePriceChange()" 
                        ng-disabled="priceChangeForm.$invalid || loading">
                    <span ng-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="bi bi-check-circle me-1"></i>Lưu thay đổi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Price History Modal -->
<div class="modal fade" id="priceHistoryModal" tabindex="-1" aria-labelledby="priceHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceHistoryModalLabel">
                    <i class="bi bi-clock-history"></i> Lịch sử giá - {{selectedBookForHistory.title}}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>ISBN:</strong> {{selectedBookForHistory.isbn}}
                    </div>
                    <div class="col-md-6">
                        <strong>Giá hiện tại:</strong> 
                        <span class="h6 text-primary">{{selectedBookForHistory.currentPrice | number}} ₫</span>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div ng-if="priceHistoryLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-3 text-muted">Đang tải lịch sử giá...</p>
                </div>
                
                <!-- Price History Table -->
                <div ng-if="!priceHistoryLoading && priceHistory.length > 0" class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ngày thay đổi</th>
                                <th>Ngày hiệu lực</th>
                                <th>Giá cũ</th>
                                <th>Giá mới</th>
                                <th>Thay đổi</th>
                                <th>Nhân viên</th>
                                <th>Lý do</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="change in priceHistory">
                                <td>{{change.changedAt | date:'dd/MM/yyyy HH:mm'}}</td>
                                <td>{{change.effectiveDate | date:'dd/MM/yyyy HH:mm'}}</td>
                                <td>{{change.oldPrice | number}} ₫</td>
                                <td>
                                    <strong class="text-primary">{{change.newPrice | number}} ₫</strong>
                                </td>
                                <td>
                                    <span ng-class="{'text-success': change.newPrice > change.oldPrice, 'text-danger': change.newPrice < change.oldPrice, 'text-muted': change.newPrice == change.oldPrice}">
                                        {{((change.newPrice - change.oldPrice) / change.oldPrice * 100) | number:1}}%
                                        <br>
                                        <small>({{change.newPrice - change.oldPrice | number}} ₫)</small>
                                    </span>
                                </td>
                                <td>{{change.employeeName}}</td>
                                <td>
                                    <span ng-if="change.reason" title="{{change.reason}}">{{truncate(change.reason, 30)}}</span>
                                    <span ng-if="!change.reason" class="text-muted">-</span>
                                </td>
                                <td>
                                    <span class="badge" ng-class="{'bg-success': change.isActive, 'bg-secondary': !change.isActive}">
                                        {{change.isActive ? 'Hoạt động' : 'Không hoạt động'}}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div ng-if="!priceHistoryLoading && priceHistory.length === 0" class="text-center py-5">
                    <i class="bi bi-clock-history text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">Chưa có lịch sử thay đổi giá</h5>
                    <p class="text-muted">Sách này chưa có thay đổi giá nào.</p>
                </div>
                
                <!-- Error State -->
                <div ng-if="priceHistoryError" class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{priceHistoryError}}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Disabled price input styling */
    #bookModal input[name="currentPrice"]:disabled {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
        cursor: not-allowed;
    }
    
    /* Authors validation styling */
    #bookModal .d-flex.flex-wrap.is-invalid {
        border: 1px solid #dc3545;
        border-radius: 0.375rem;
        padding: 0.5rem;
        background-color: #fff5f5;
    }
    
    #bookModal .d-flex.flex-wrap.is-invalid .badge {
        border: 1px solid #dc3545;
    }
</style>
