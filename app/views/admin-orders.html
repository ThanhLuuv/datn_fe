<div class="container-fluid py-4" ng-controller="AdminOrdersController">
	<div class="row">
		<div class="col-12">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<div class="d-flex align-items-center">
					<a href="#!/admin" class="btn btn-outline-secondary me-3">
						<i class="bi bi-arrow-left"></i> Quay lại
					</a>
					<h2 class="mb-0"><i class="bi bi-bag"></i> Quản lý đơn hàng</h2>
				</div>
			</div>

			<!-- Loading State -->
			<div ng-if="loading" class="text-center py-5">
				<div class="spinner-border text-primary" role="status">
					<span class="visually-hidden">Đang tải...</span>
				</div>
				<p class="mt-3 text-muted">Đang tải danh sách đơn hàng...</p>
			</div>

			<!-- Search Filters -->
			<div class="row g-2 mb-3" ng-if="!loading">
				<div class="col-md-3">
					<input class="form-control" placeholder="Từ khóa" ng-model="filters.keyword" />
				</div>
				<div class="col-md-2">
					<select class="form-select" ng-model="filters.status">
						<option value="">Tất cả</option>
						<option value="Pending">Chờ duyệt</option>
						<option value="Assigned">Đang giao</option>
						<option value="Delivered">Đã giao</option>
					</select>
				</div>
				<div class="col-md-2">
					<input type="date" class="form-control" ng-model="filters.fromDate" />
				</div>
				<div class="col-md-2">
					<input type="date" class="form-control" ng-model="filters.toDate" />
				</div>
				<div class="col-md-3 text-end">
					<button class="btn btn-primary" ng-click="search()">
						<i class="bi bi-search"></i> Tìm kiếm
					</button>
				</div>
			</div>

			<!-- Orders Table -->
			<div class="card" ng-if="!loading">
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-hover mb-0">
							<thead class="table-light">
								<tr>
									<th>Mã đơn</th>
									<th>Khách hàng</th>
									<th>Ngày đặt</th>
									<th>Trạng thái</th>
									<th class="text-end">Tổng tiền</th>
									<th class="text-end">Thao tác</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="o in orders">
									<td><code>OD-{{o.orderId || o.id}}</code></td>
									<td>{{o.customerName}}</td>
									<td>{{o.placedAt | date:'yyyy-MM-dd HH:mm'}}</td>
									<td>
										<span class="badge"
											ng-class="{
												'bg-warning': o.status === 'Pending',
												'bg-primary': o.status === 'Assigned',
												'bg-success': o.status === 'Delivered',
												'bg-secondary': !o.status
											}">
											{{o.status || 'Không xác định'}}
										</span>
									</td>
									<td class="text-end">{{o.totalAmount | currency}}</td>
									<td class="text-end">
										<div class="btn-group btn-group-sm">
									<button class="btn btn-outline-secondary" ng-click="viewOrder(o)" title="Chi tiết" data-bs-toggle="modal" data-bs-target="#orderDetailModal">
												<i class="bi bi-eye"></i>
											</button>
										<button class="btn btn-outline-danger" ng-click="approveOrder(o, false)" ng-if="getOrderStatus(o)==='Pending'" title="Hủy đơn">
											<i class="bi bi-x-circle"></i>
										</button>
										<button class="btn btn-outline-primary" ng-click="assignDelivery(o)" ng-if="getOrderStatus(o)==='Pending'" title="Phân công giao">
												<i class="bi bi-truck"></i>
											</button>
										<button class="btn btn-outline-dark" ng-click="confirmDelivered(o)" ng-if="getOrderStatus(o)==='Assigned'" title="Xác nhận giao">
												<i class="bi bi-bag-check"></i>
											</button>
										<button class="btn btn-outline-warning" ng-click="returnOrder(o)" ng-if="getOrderStatus(o)==='Delivered'" title="Trả hàng">
												<i class="bi bi-arrow-counterclockwise"></i>
											</button>
										</div>
									</td>
								</tr>
								<tr ng-if="!loading && orders.length === 0">
									<td colspan="6" class="text-center py-3">Chưa có đơn hàng nào</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Empty State -->
			<empty-state 
				show="!loading && orders.length === 0" 
				title="Chưa có đơn hàng nào"
				message="Hệ thống chưa có đơn hàng nào để hiển thị">
			</empty-state>

			<!-- Pagination -->
			<pagination 
				current-page="currentPage" 
				total-pages="totalPages" 
				on-page-change="onPageChange(page)">
			</pagination>
			</div>
		</div>
	</div>

	<!-- Order detail modal (Bootstrap) -->
	<div class="modal fade" id="orderDetailModal" tabindex="-1">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="bi bi-bag"></i> Chi tiết đơn hàng
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" ng-if="$root.selectedOrder">
					<div class="row g-3 mb-3">
						<div class="col-12">
							<div class="card shadow-sm border-0">
								<div class="card-body py-3">
									<h6 class="text-uppercase text-muted small mb-3">Thông tin đơn hàng</h6>
									<div class="row small g-3">
										<div class="col-md-3">
											<div class="text-muted">Mã đơn</div>
											<div><code>OD-{{$root.selectedOrder.orderId || $root.selectedOrder.id}}</code></div>
										</div>
										<div class="col-md-3">
											<div class="text-muted">Khách hàng</div>
											<div class="fw-semibold text-truncate">{{$root.selectedOrder.customerName}}</div>
										</div>
										<div class="col-md-3">
											<div class="text-muted">Ngày đặt</div>
											<div>{{$root.selectedOrder.placedAt | date:'yyyy-MM-dd HH:mm'}}</div>
										</div>
										<div class="col-md-3">
											<div class="text-muted">Trạng thái</div>
											<div>
												<span class="badge"
													ng-class="{
																'bg-warning': $root.selectedOrder.status === 'Pending',
																'bg-primary': $root.selectedOrder.status === 'Assigned',
																'bg-success': $root.selectedOrder.status === 'Delivered',
																'bg-secondary': !$root.selectedOrder.status
													}">
															{{$root.selectedOrder.status || 'Không xác định'}}
												</span>
											</div>
										</div>
									</div>
									<div class="row small g-3 mt-1">
										<div class="col-md-4">
											<div class="text-muted">Người nhận</div>
											<div>{{$root.selectedOrder.receiverName}} - {{$root.selectedOrder.receiverPhone}}</div>
										</div>
										<div class="col-md-5">
											<div class="text-muted">Địa chỉ giao</div>
											<div class="text-truncate">{{$root.selectedOrder.shippingAddress}}</div>
										</div>
										<div class="col-md-3">
											<div class="text-muted">Tổng tiền</div>
											<div class="h6 text-success mb-0">{{$root.selectedOrder.totalAmount | currency}}</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="border-top pt-3">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<h6 class="mb-0">Sản phẩm trong đơn</h6>
									<span class="text-muted small">{{($root.selectedOrder.lines || []).length}} dòng</span>
						</div>
						<div class="table-responsive">
							<table class="table table-sm table-striped align-middle">
								<thead class="table-light">
									<tr>
										<th style="width: 15%">ISBN</th>
										<th>Tên sách</th>
										<th class="text-end" style="width: 12%">SL</th>
										<th class="text-end" style="width: 15%">Đơn giá</th>
										<th class="text-end" style="width: 18%">Thành tiền</th>
									</tr>
								</thead>
								<tbody>
									<tr ng-repeat="l in ($root.selectedOrder.lines || [])">
										<td class="text-nowrap"><code>{{l.isbn}}</code></td>
										<td class="text-truncate" style="max-width: 340px">{{l.bookTitle}}</td>
										<td class="text-end"><span class="badge bg-primary">{{l.quantity || l.qty}}</span></td>
										<td class="text-end">{{l.unitPrice | currency}}</td>
										<td class="text-end"><strong>{{( (l.quantity || l.qty) * l.unitPrice) | currency}}</strong></td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="d-flex justify-content-end mt-2">
							<div class="text-end">
								<div class="small text-muted">Tổng tiền</div>
										<div class="h5 text-success mb-0">{{$root.selectedOrder.totalAmount | currency}}</div>
							</div>
						</div>
					</div>
				</div>
				<div class="px-3 pb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2" ng-if="getOrderStatus($root.selectedOrder)==='Pending'">
                        <h6 class="mb-0"><i class="bi bi-people"></i> Gợi ý nhân viên giao hàng</h6>
                        <div class="d-flex align-items-center gap-2">
                            <div>
                                <input type="datetime-local" class="form-control form-control-sm" ng-class="{'is-invalid': dateInvalid}" style="width: 220px" ng-model="deliveryDateInput" ng-change="updateDeliveryDateValidity()" min="{{deliveryDateMin}}" required placeholder="Ngày giao" />
                                <div class="invalid-feedback d-block" ng-show="dateInvalid">Vui lòng chọn thời điểm giao hợp lệ (không ở quá khứ).</div>
                            </div>
                            <button class="btn btn-sm btn-outline-info" ng-click="resetDeliveryDate()" title="Reset ngày giao">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        <button class="btn btn-sm btn-outline-secondary" ng-click="refreshDeliveryCandidates($root.selectedOrder.orderId || $root.selectedOrder.id)" ng-disabled="candidatesLoading">
                            <span ng-if="!candidatesLoading"><i class="bi bi-arrow-clockwise"></i> Làm mới</span>
                            <span ng-if="candidatesLoading"><span class="spinner-border spinner-border-sm me-1"></span>Đang tải</span>
                        </button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2" ng-if="getOrderStatus($root.selectedOrder)!=='Pending'">
                        <h6 class="mb-0"><i class="bi bi-person-badge"></i> Nhân viên giao hàng</h6>
                    </div>
                    <div class="table-responsive" ng-if="getOrderStatus($root.selectedOrder)==='Pending'">
						<table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nhân viên</th>
                                    <th>Khu vực</th>
                                    <th class="text-center">Khớp khu vực</th>
                                    <th class="text-end">Đang giao</th>
                                    <th class="text-end">Đã giao</th>
                                    <th class="text-end">Thao tác</th>
                                </tr>
                            </thead>
							<tbody>
								<tr ng-if="candidatesLoading">
									<td colspan="8" class="text-center py-3">
										<div class="spinner-border spinner-border-sm text-primary" role="status"></div>
										<span class="ms-2 text-muted small">Đang tải gợi ý...</span>
									</td>
								</tr>
                                <tr ng-repeat="c in deliveryCandidates">
                                    <td>
                                        <div class="fw-semibold">{{c.fullName}} <small class="text-muted">(#{{c.employeeId || c.id}})</small></div>
                                        <div class="small text-muted">{{c.phone || '—'}} · {{c.email || '—'}}</div>
                                    </td>
									<td>{{c.areaName || '—'}}</td>
                                    <td class="text-center">
                                        <span class="badge" ng-class="{ 'bg-success': c.isAreaMatched, 'bg-secondary': !c.isAreaMatched }">{{c.isAreaMatched ? 'Khớp' : 'Không'}}</span>
                                    </td>
                                    <td class="text-end">{{(c.activeAssignedOrders != null) ? c.activeAssignedOrders : ((c.activeAssigned != null) ? c.activeAssigned : 0)}}</td>
                                    <td class="text-end">{{(c.totalDeliveredOrders != null) ? c.totalDeliveredOrders : ((c.delivered != null) ? c.delivered : 0)}}</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary" ng-click="assignDeliveryCandidate($root.selectedOrder, c)" ng-disabled="dateInvalid || !deliveryDateInput"><i class="bi bi-truck"></i> Phân công</button>
									</td>
								</tr>
								<tr ng-if="!candidatesLoading && deliveryCandidates.length === 0">
									<td colspan="8" class="text-center text-muted py-2">Chưa có gợi ý.</td>
								</tr>
							</tbody>
						</table>
					</div>
                    <div class="table-responsive" ng-if="getOrderStatus($root.selectedOrder)!=='Pending'">
                        <table class="table table-sm align-middle">
                            <tbody>
                                <tr>
                                    <td style="width:60%">
                                        <div class="fw-semibold">{{$root.selectedOrder.deliveredByName || $root.selectedOrder.deliveryEmployeeName || 'Chưa rõ'}}</div>
                                        <div class="small text-muted">ID: {{$root.selectedOrder.deliveredBy || $root.selectedOrder.deliveryEmployeeId || '—'}}</div>
                                    </td>
                                    <td class="text-end" style="width:40%">
                                        <div class="small text-muted">Ngày giao dự kiến</div>
                                        <div>{{($root.selectedOrder.deliveryDate || $root.selectedOrder.deliveryAt) | date:'yyyy-MM-dd HH:mm'}}</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Return Modal -->
	<div class="modal fade" id="returnModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-arrow-counterclockwise"></i> Lập phiếu trả</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-2">
                        <label class="form-label small">Lý do</label>
                        <input type="text" class="form-control" ng-model="$root.returnModel.reason" placeholder="Lý do trả hàng" />
					</div>
					<div class="table-responsive" style="max-height: 320px; overflow:auto;">
						<table class="table table-sm align-middle">
							<thead class="table-light">
								<tr>
									<th>Sách</th>
									<th class="text-end">Đã mua</th>
									<th style="width: 120px" class="text-end">Trả</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-if="returnLoading">
									<td colspan="3" class="text-center py-3">
										<div class="spinner-border spinner-border-sm text-primary" role="status"></div>
										<span class="ms-2 text-muted small">Đang tải dòng đơn...</span>
									</td>
								</tr>
                                <tr ng-repeat="l in $root.returnModel.lines track by $index">
									<td>
										<div class="fw-semibold">{{l.bookTitle || ('#' + l.orderLineId)}}</div>
										<div class="small text-muted">Đơn giá: {{l.unitPrice | currency}}</div>
									</td>
                                    <td class="text-end"><span class="badge bg-secondary">{{l.maxQty}}</span></td>
									<td class="text-end">
										<input type="number" class="form-control form-control-sm text-end" min="0" max="{{l.maxQty}}" ng-model="l.qtyReturned" />
									</td>
								</tr>
                                <tr ng-if="!returnLoading && (!$root.returnModel || !$root.returnModel.lines || $root.returnModel.lines.length===0)">
									<td colspan="3" class="text-center text-muted py-2">Không có dòng nào.</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
					<button type="button" class="btn btn-warning" ng-click="submitReturn()"><i class="bi bi-arrow-counterclockwise"></i> Tạo phiếu trả</button>
				</div>
			</div>
		</div>
	</div>
	<!-- Toasts -->
	<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2000;">
		<div class="toast align-items-center text-white bg-{{t.variant}} border-0 mb-2 show" role="alert" aria-live="assertive" aria-atomic="true" ng-repeat="t in toasts">
			<div class="d-flex">
				<div class="toast-body">{{t.message}}</div>
			</div>
		</div>
	</div>
</div>