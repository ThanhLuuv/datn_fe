<!DOCTYPE html>
<html lang="vi" ng-app="myApp" ng-strict-di>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookStore</title>
    <link rel="icon" type="image/png" href="app/assets/images/logo.png">
    <link rel="shortcut icon" type="image/png" href="app/assets/images/logo.png">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/custom/main.css?v=1.5" rel="stylesheet">
    <link href="/css/custom/auth.css?v=1.5" rel="stylesheet">
    
    <style>
        /* Enhanced Navbar Styles */
        .navbar .nav-link {
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .navbar .dropdown-menu .dropdown-item {
            font-size: 0.95rem;
        }
        .navbar .brand-text {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .cart-link {
            position: relative;
            transition: all 0.3s ease;
        }
        .cart-link:hover {
            transform: scale(1.05);
        }
        .cart-badge {
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .navbar-nav .nav-link:hover {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .navbar-nav .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white !important;
            border-radius: 8px;
        }
        /* Mobile Search */
        @media (max-width: 991px) {
            .navbar-search {
                display: block !important;
                margin: 1rem 0;
            }
            .search-input-group {
                width: 100%;
            }
        }
    </style>
    
    <!-- jQuery (must load first) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AngularJS -->
    <script defer src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script defer src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>
    <script defer src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Debug Scripts -->
    <script>
        // English: log any script load error (404, CORS, MIME)
        // Ti·∫øng Vi·ªát: log l·ªói t·∫£i file .js (404, CORS, MIME)
        window.addEventListener('error', function (e) {
            const t = e.target || e.srcElement;
            if (t && t.tagName === 'SCRIPT') {
                console.error('‚ùå Script load failed:', t.src || t.getAttribute('src'));
            }
        }, true);
    </script>
</head>
<body ng-controller="AppController">
    <!-- Navigation - Hidden for Admin and Auth Pages -->
    <nav class="navbar navbar-expand-lg navbar-dark bookstore-navbar" ng-hide="isAdminPage || isAuthPage">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand" href="#!/home">
                <img src="/app/assets/images/logo.png" alt="BookStore Logo" class="navbar-logo">
                <span class="brand-text">BookStore</span>
            </a>
            
            <!-- Search Bar -->
            <div class="navbar-search d-none d-lg-flex">
                <div class="search-input-group">
                    <input type="text" 
                           class="form-control search-input" 
                           placeholder="T√¨m ki·∫øm s√°ch, t√°c gi·∫£..." 
                           ng-model="searchQuery" 
                           ng-keypress="$event.which === 13 && goSearch()">
                    <button class="btn btn-search" type="button" ng-click="goSearch()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Navigation Menu -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                </ul>
                
                <!-- User Actions -->
                <ul class="navbar-nav">
                    <!-- Cart -->
                    <li class="nav-item me-2">
                        <a class="nav-link position-relative cart-link" href="#!/cart" aria-label="Gi·ªè h√†ng">
                            <i class="bi bi-cart3"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge" 
                                  ng-show="cartCount > 0">{{cartCount}}</span>
                        </a>
                    </li>
                    
                    <!-- Authentication -->
                    <li class="nav-item" ng-if="!isAuthenticated">
                        <a class="nav-link" href="#!/login">
                            <i class="bi bi-box-arrow-in-right me-1"></i>
                            <span class="d-none d-md-inline">ƒêƒÉng nh·∫≠p</span>
                        </a>
                    </li>
                    <li class="nav-item" ng-if="!isAuthenticated">
                        <a class="nav-link" href="#!/register">
                            <i class="bi bi-person-plus me-1"></i>
                            <span class="d-none d-md-inline">ƒêƒÉng k√Ω</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" ng-if="isAuthenticated">
                        <a class="nav-link dropdown-toggle user-menu" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#!/admin" ng-if="isAuthenticated && (currentUser.roleId === 3 || currentUser.roleId === 2 || currentUser.roleId === 4)">
                                <i class="bi bi-person me-2"></i>Trang qu·∫£n l√Ω
                            </a></li>
                            <li><a class="dropdown-item" href="#!/profile">
                                <i class="bi bi-person me-2"></i>Th√¥ng tin c√° nh√¢n
                            </a></li>
                            <li><a class="dropdown-item" href="#!/orders">
                                <i class="bi bi-bag me-2"></i>ƒê∆°n h√†ng c·ªßa t√¥i
                            </a></li>
                            <li><a class="dropdown-item" href="#!/wishlist">
                                <i class="bi bi-heart me-2"></i>Danh s√°ch y√™u th√≠ch
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" ng-click="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>ƒêƒÉng xu·∫•t
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid" ng-class="{'admin-fullscreen': isAdminPage, 'p-0': isAuthPage}">
        <div ng-view></div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light text-center py-3 mt-5" ng-hide="isAuthPage">
        <div class="container">
            <p>&copy; 2024 D·ª± √°n Frontend. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </footer>

    <!-- Environment Configuration (Dynamic Detection) -->
    <script>
        // Detect environment dynamically with local override
        const h = location.hostname;
        const p = Number(location.port || 0);
        const isLocalHost =
            h === 'localhost' || h === '127.0.0.1' || h === '0.0.0.0' ||
            /^192\.168\./.test(h) || /^10\./.test(h) || /\.local$/i.test(h) ||
            p === 3000 || p === 4200 || p === 5173 || p === 8080; // c√°c c·ªïng dev ph·ªï bi·∫øn

        const isVercel = /vercel\.app$|now\.sh$/.test(h);

        // Cho ph√©p √©p m√¥i tr∆∞·ªùng qua query (?env=local|staging|prod)
        const qsEnv = new URLSearchParams(location.search).get('env');

        const ENVIRONMENT =
            qsEnv === 'local' ? 'development' :
            qsEnv === 'staging' ? 'staging' :
            qsEnv === 'prod' ? 'production' :
            isLocalHost ? 'development' :
            isVercel ? 'production' : 'staging';

        const API_BASE_URL = ENVIRONMENT === 'development'
            ? 'http://localhost:5256/api'
            : 'https://bookstore-api-386583671447.asia-southeast1.run.app/api';

        window.ENV_CONFIG = {
            API_BASE_URL,
            ENVIRONMENT,
            API_TIMEOUT: 15000,
            APP_NAME: 'BookStore Frontend',
            APP_VERSION: '1.0.0',
            APP_DESCRIPTION: 'D·ª± √°n Frontend s·ª≠ d·ª•ng AngularJS + Bootstrap',
            DEBUG_MODE: ENVIRONMENT === 'development',
            ITEMS_PER_PAGE: 10,
            MAX_PAGES_DISPLAY: 5,
            DATE_FORMAT: 'dd/MM/yyyy',
            DATETIME_FORMAT: 'dd/MM/yyyy HH:mm:ss',
            EMAIL_REGEX: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            PHONE_REGEX: /^[0-9]{10,11}$/,
            MESSAGES: {
                SUCCESS: 'Thao t√°c th√†nh c√¥ng!',
                ERROR: 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!',
                LOADING: 'ƒêang t·∫£i d·ªØ li·ªáu...',
                NO_DATA: 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                CONFIRM_DELETE: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?',
                REQUIRED_FIELD: 'Tr∆∞·ªùng n√†y l√† b·∫Øt bu·ªôc',
                INVALID_EMAIL: 'Email kh√¥ng h·ª£p l·ªá',
                INVALID_PHONE: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá'
            },
            STORAGE_KEYS: {
                USER_TOKEN: 'user_token',
                USER_INFO: 'user_info',
                THEME: 'theme',
                LANGUAGE: 'language'
            },
            FEATURES: {
                ENABLE_DEBUG_LOGS: ENVIRONMENT === 'development',
                ENABLE_API_LOGGING: ENVIRONMENT === 'development',
                ENABLE_PERFORMANCE_MONITORING: true
            }
        };
        
        console.log('ENV:', ENVIRONMENT, 'API:', API_BASE_URL);
        console.log('Hostname:', h, 'Port:', p, 'isLocalHost:', isLocalHost);
    </script>

    <!-- AngularJS App Module -->
    <script defer src="/js/angular/app.js?v=1.5"></script>
    
    <!-- Configuration -->
    <script defer src="/js/angular/app.config.js?v=1.3"></script>
    
    <!-- Services -->
    <script defer src="/js/angular/services/dataService.js?v=1.3"></script>
    <script defer src="/js/angular/services/authService.js?v=1.3"></script>
    <script defer src="/js/angular/services/bookstoreService.js?v=1.3"></script>
    <script defer src="/js/angular/services/cartService.js"></script>
    
    <!-- Filters (defer to ensure Angular is loaded first) -->
    <script defer src="/js/angular/filters/customFilters.js"></script>
    <script defer src="/js/angular/filters/bookstoreFilters.js"></script>
    
    <!-- Controllers -->
    <script defer src="/js/angular/controllers/homeController.js"></script>
    <script defer src="/js/angular/controllers/aboutController.js"></script>
    <script defer src="/js/angular/controllers/contactController.js"></script>
    <script defer src="/js/angular/controllers/authController.js"></script>
    <script defer src="/js/angular/controllers/adminController.js"></script>
    <script defer src="/js/angular/controllers/employeeController.js"></script>
    <script defer src="/js/angular/controllers/apiTestController.js"></script>
    <script defer src="/js/angular/controllers/categoryController.js"></script>
    <script defer src="/js/angular/controllers/bookController.js"></script>
    <script defer src="/js/angular/controllers/searchController.js"></script>
    <script defer src="/js/angular/controllers/cartController.js"></script>
    <script defer src="/js/angular/controllers/checkoutController.js"></script>
    <script defer src="/js/angular/controllers/successController.js"></script>
    <script defer src="/js/angular/controllers/bookDetailController.js"></script>
    <script defer src="/js/angular/controllers/customerOrdersController.js"></script>
    <script defer src="/js/angular/controllers/purchaseOrderController.js"></script>
    <script defer src="/js/angular/controllers/goodsReceiptController.js"></script>
    <script defer src="/js/angular/controllers/reportController.js"></script>
    <script defer src="/js/angular/controllers/adminInventoryReportController.js"></script>
    <script defer src="/js/angular/controllers/rolesController.js"></script>
    <script defer src="/js/angular/controllers/orderController.js"></script>
    <script defer src="/js/angular/controllers/returnController.js"></script>
    <script defer src="/js/angular/controllers/promotionController.js"></script>
    <script defer src="/js/angular/controllers/deliveryOrdersController.js"></script>
    
    <!-- Directives -->
    <script defer src="/js/angular/directives/customDirectives.js?v=1.4"></script>
    <script defer src="/js/angular/directives/authDirectives.js?v=1.4"></script>
    <script defer src="/js/angular/directives/permissionDirectives.js?v=1.4"></script>
    <script defer src="/js/angular/directives/commonDirectives.js?v=1.4"></script>
    
    <!-- Custom jQuery -->
    <script defer src="/js/custom/main.js"></script>
    
    <!-- Check myApp module exists (after all AngularJS scripts load) -->
    <script defer src="/js/check-myapp.js"></script>
    
    <!-- Debug: Check script loading status -->
    <script defer>
        console.log('üîç Debug: Checking script loading status...');
        console.log('jQuery loaded:', !!window.jQuery);
        console.log('AngularJS loaded:', !!window.angular);
        console.log('myApp module:', (function() {
            try { return !!angular.module('myApp'); } catch(e) { return false; }
        })());
        
        // Check if ng-view is working
        setTimeout(function() {
            var ngView = document.querySelector('[ng-view]');
            console.log('ng-view element:', ngView);
            console.log('ng-view content:', ngView ? ngView.innerHTML : 'not found');
        }, 1000);
    </script>
</body>
</html>