<!DOCTYPE html>
<html lang="vi" ng-app="myApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookStore</title>
    <link rel="icon" type="image/png" href="app/assets/images/logo.png">
    <link rel="shortcut icon" type="image/png" href="app/assets/images/logo.png">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/custom/main.css?v=1.5" rel="stylesheet">
    <link href="css/custom/auth.css?v=1.5" rel="stylesheet">
    
    <style>
        /* Enhanced Navbar Styles */
        .navbar .nav-link {
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .navbar .dropdown-menu .dropdown-item {
            font-size: 0.95rem;
        }
        .navbar .brand-text {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .cart-link {
            position: relative;
            transition: all 0.3s ease;
        }
        .cart-link:hover {
            transform: scale(1.05);
        }
        .cart-badge {
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .navbar-nav .nav-link:hover {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .navbar-nav .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white !important;
            border-radius: 8px;
        }
        /* Mobile Search */
        @media (max-width: 991px) {
            .navbar-search {
                display: block !important;
                margin: 1rem 0;
            }
            .search-input-group {
                width: 100%;
            }
        }
    </style>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body ng-controller="AppController">
    <!-- Navigation - Hidden for Admin and Auth Pages -->
    <nav class="navbar navbar-expand-lg navbar-dark bookstore-navbar" ng-hide="isAdminPage || isAuthPage">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand" href="#!/home">
                <img src="app/assets/images/logo.png" alt="BookStore Logo" class="navbar-logo">
                <span class="brand-text">BookStore</span>
            </a>
            
            <!-- Search Bar -->
            <div class="navbar-search d-none d-lg-flex">
                <div class="search-input-group">
                    <input type="text"
                           class="form-control search-input"
                           placeholder="Tìm kiếm sách, tác giả..."
                           ng-model="searchQuery"
                           ng-keypress="$event.which === 13 && goSearch()">
                    <button class="btn btn-search" type="button" ng-click="goSearch()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Navigation Menu -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                </ul>
                
                <!-- User Actions -->
                <ul class="navbar-nav">
                    <!-- Cart -->
                    <li class="nav-item me-2">
                        <a class="nav-link position-relative cart-link" href="#!/cart" aria-label="Giỏ hàng">
                            <i class="bi bi-cart3"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge"
                                  ng-show="cartCount > 0">{{cartCount}}</span>
                        </a>
                    </li>
                    
                    <!-- Authentication -->
                    <li class="nav-item" ng-if="!isAuthenticated">
                        <a class="nav-link" href="#!/login">
                            <i class="bi bi-box-arrow-in-right me-1"></i>
                            <span class="d-none d-md-inline">Đăng nhập</span>
                        </a>
                    </li>
                    <li class="nav-item" ng-if="!isAuthenticated">
                        <a class="nav-link" href="#!/register">
                            <i class="bi bi-person-plus me-1"></i>
                            <span class="d-none d-md-inline">Đăng ký</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" ng-if="isAuthenticated">
                        <a class="nav-link dropdown-toggle user-menu" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#!/admin" ng-if="isAuthenticated && (currentUser.roleId === 3 || currentUser.roleId === 2 || currentUser.roleId === 4)">
                                <i class="bi bi-person me-2"></i>Trang quản lý
                            </a></li>
                            <li><a class="dropdown-item" href="#!/profile">
                                <i class="bi bi-person me-2"></i>Thông tin cá nhân
                            </a></li>
                            <li><a class="dropdown-item" href="#!/orders">
                                <i class="bi bi-bag me-2"></i>Đơn hàng của tôi
                            </a></li>
                            <li><a class="dropdown-item" href="#!/wishlist">
                                <i class="bi bi-heart me-2"></i>Danh sách yêu thích
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" ng-click="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid" ng-class="{'admin-fullscreen': isAdminPage, 'p-0': isAuthPage}">
        <div ng-view></div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light text-center py-3 mt-5" ng-hide="isAuthPage">
        <div class="container">
            <p>&copy; 2024 Dự án Frontend. Tất cả quyền được bảo lưu.</p>
        </div>
    </footer>

    <!-- Environment Configuration (embedded for Vercel) -->
    <script>
        // Production Environment Configuration for Vercel
        window.ENV_CONFIG = {
            API_BASE_URL: 'https://bookstore-api-386583671447.asia-southeast1.run.app/api',
            API_TIMEOUT: 15000,
            APP_NAME: 'BookStore Frontend',
            APP_VERSION: '1.0.0',
            APP_DESCRIPTION: 'Dự án Frontend sử dụng AngularJS + Bootstrap',
            ENVIRONMENT: 'production',
            DEBUG_MODE: false,
            ITEMS_PER_PAGE: 10,
            MAX_PAGES_DISPLAY: 5,
            DATE_FORMAT: 'dd/MM/yyyy',
            DATETIME_FORMAT: 'dd/MM/yyyy HH:mm:ss',
            EMAIL_REGEX: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            PHONE_REGEX: /^[0-9]{10,11}$/,
            MESSAGES: {
                SUCCESS: 'Thao tác thành công!',
                ERROR: 'Có lỗi xảy ra, vui lòng thử lại!',
                LOADING: 'Đang tải dữ liệu...',
                NO_DATA: 'Không có dữ liệu',
                CONFIRM_DELETE: 'Bạn có chắc chắn muốn xóa?',
                REQUIRED_FIELD: 'Trường này là bắt buộc',
                INVALID_EMAIL: 'Email không hợp lệ',
                INVALID_PHONE: 'Số điện thoại không hợp lệ'
            },
            STORAGE_KEYS: {
                USER_TOKEN: 'user_token',
                USER_INFO: 'user_info',
                THEME: 'theme',
                LANGUAGE: 'language'
            },
            FEATURES: {
                ENABLE_DEBUG_LOGS: false,
                ENABLE_API_LOGGING: false,
                ENABLE_PERFORMANCE_MONITORING: true
            }
        };
        console.log('✅ Environment config loaded for Vercel production');
        console.log('API Base URL:', window.ENV_CONFIG.API_BASE_URL);
    </script>

    <!-- AngularJS App Module (Embedded for Vercel) -->
    <script>
        console.log('Loading AngularJS App Module...');

        // Define the main app module
        var myApp = angular.module('myApp', [
            'ngRoute',
            'ngAnimate'
        ]);

        // App Controller - Main controller for the entire app
        myApp.controller('AppController', ['$scope', '$location', '$rootScope', function($scope, $location, $rootScope) {
            console.log('AppController loaded');
            
            // Initialize app state
            $scope.isAuthenticated = false;
            $scope.currentUser = null;
            $scope.cartCount = 0;
            $scope.searchQuery = '';
            
            // Check if current page is admin page
            $scope.isAdminPage = false;
            $scope.isAuthPage = false;
            
            // Watch for route changes
            $rootScope.$on('$routeChangeSuccess', function(event, current, previous) {
                var path = $location.path();
                $scope.isAdminPage = path.indexOf('/admin') === 0;
                $scope.isAuthPage = path === '/login' || path === '/register';
                
                console.log('Route changed to:', path);
                console.log('Is admin page:', $scope.isAdminPage);
                console.log('Is auth page:', $scope.isAuthPage);
            });
            
            // Search functionality
            $scope.goSearch = function() {
                if ($scope.searchQuery && $scope.searchQuery.trim()) {
                    $location.path('/search').search('q', $scope.searchQuery.trim());
                }
            };
            
            // Logout functionality
            $scope.logout = function() {
                $scope.isAuthenticated = false;
                $scope.currentUser = null;
                $scope.cartCount = 0;
                $location.path('/home');
                console.log('User logged out');
            };
        }]);

        // App Configuration - Routes
        myApp.config(['$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {
            console.log('Configuring routes...');
            
            // Enable HTML5 mode for clean URLs
            $locationProvider.html5Mode(false);
            $locationProvider.hashPrefix('');
            
            // Define routes
            $routeProvider
                .when('/home', {
                    templateUrl: 'app/views/home.html',
                    controller: 'HomeController'
                })
                .when('/about', {
                    templateUrl: 'app/views/about.html',
                    controller: 'AboutController'
                })
                .when('/contact', {
                    templateUrl: 'app/views/contact.html',
                    controller: 'ContactController'
                })
                .when('/login', {
                    templateUrl: 'app/views/login.html',
                    controller: 'AuthController'
                })
                .when('/register', {
                    templateUrl: 'app/views/register.html',
                    controller: 'AuthController'
                })
                .when('/books', {
                    templateUrl: 'app/views/books.html',
                    controller: 'BookController'
                })
                .when('/book/:id', {
                    templateUrl: 'app/views/book-detail.html',
                    controller: 'BookDetailController'
                })
                .when('/categories', {
                    templateUrl: 'app/views/categories.html',
                    controller: 'CategoryController'
                })
                .when('/search', {
                    templateUrl: 'app/views/search.html',
                    controller: 'SearchController'
                })
                .when('/cart', {
                    templateUrl: 'app/views/cart.html',
                    controller: 'CartController'
                })
                .when('/checkout', {
                    templateUrl: 'app/views/checkout.html',
                    controller: 'CheckoutController'
                })
                .when('/success', {
                    templateUrl: 'app/views/success.html',
                    controller: 'SuccessController'
                })
                .when('/orders', {
                    templateUrl: 'app/views/customer-orders.html',
                    controller: 'CustomerOrdersController'
                })
                .when('/admin', {
                    templateUrl: 'app/views/admin.html',
                    controller: 'AdminController'
                })
                .when('/admin/books', {
                    templateUrl: 'app/views/admin-books.html',
                    controller: 'BookController'
                })
                .when('/admin/categories', {
                    templateUrl: 'app/views/admin-categories.html',
                    controller: 'CategoryController'
                })
                .when('/admin/orders', {
                    templateUrl: 'app/views/admin-orders.html',
                    controller: 'OrderController'
                })
                .when('/admin/purchase-orders', {
                    templateUrl: 'app/views/admin-purchase-orders.html',
                    controller: 'PurchaseOrderController'
                })
                .when('/admin/goods-receipts', {
                    templateUrl: 'app/views/admin-goods-receipts.html',
                    controller: 'GoodsReceiptController'
                })
                .when('/admin/returns', {
                    templateUrl: 'app/views/admin-returns.html',
                    controller: 'ReturnController'
                })
                .when('/admin/promotions', {
                    templateUrl: 'app/views/admin-promotions.html',
                    controller: 'PromotionController'
                })
                .when('/admin/roles', {
                    templateUrl: 'app/views/admin-roles.html',
                    controller: 'RolesController'
                })
                .when('/admin/report-revenue', {
                    templateUrl: 'app/views/admin-report-revenue.html',
                    controller: 'ReportController'
                })
                .when('/employee', {
                    templateUrl: 'app/views/employee.html',
                    controller: 'EmployeeController'
                })
                .when('/api-test', {
                    templateUrl: 'app/views/api-test.html',
                    controller: 'ApiTestController'
                })
                .otherwise({
                    redirectTo: '/home'
                });
            
            console.log('Routes configured successfully');
        }]);

        console.log('AngularJS App Module loaded successfully');
    </script>
    
    <!-- Configuration -->
    <script src="js/angular/app.config.js?v=1.3"></script>
    
    <!-- Services -->
    <script src="js/angular/services/dataService.js?v=1.3"></script>
    <script src="js/angular/services/authService.js?v=1.3"></script>
    <script src="js/angular/services/bookstoreService.js?v=1.3"></script>
    <script src="js/angular/services/cartService.js"></script>
    
    <!-- Controllers -->
    <script src="js/angular/controllers/homeController.js"></script>
    <script src="js/angular/controllers/aboutController.js"></script>
    <script src="js/angular/controllers/contactController.js"></script>
    <script src="js/angular/controllers/authController.js"></script>
    <script src="js/angular/controllers/adminController.js"></script>
    <script src="js/angular/controllers/employeeController.js"></script>
    <script src="js/angular/controllers/apiTestController.js"></script>
    <script src="js/angular/controllers/categoryController.js"></script>
    <script src="js/angular/controllers/bookController.js"></script>
    <script src="js/angular/controllers/searchController.js"></script>
    <script src="js/angular/controllers/cartController.js"></script>
    <script src="js/angular/controllers/checkoutController.js"></script>
    <script src="js/angular/controllers/successController.js"></script>
    <script src="js/angular/controllers/customerOrdersController.js"></script>
    <script src="js/angular/controllers/purchaseOrderController.js"></script>
    <script src="js/angular/controllers/goodsReceiptController.js"></script>
    <script src="js/angular/controllers/reportController.js"></script>
    <script src="js/angular/controllers/rolesController.js"></script>
    <script src="js/angular/controllers/orderController.js"></script>
    <script src="js/angular/controllers/returnController.js"></script>
    <script src="js/angular/controllers/promotionController.js"></script>
    
    <!-- Directives -->
    <script src="js/angular/directives/customDirectives.js?v=1.4"></script>
    <script src="js/angular/directives/authDirectives.js?v=1.4"></script>
    <script src="js/angular/directives/permissionDirectives.js?v=1.4"></script>
    <script src="js/angular/directives/commonDirectives.js?v=1.4"></script>
    
    <!-- Filters -->
    <script src="js/angular/filters/customFilters.js"></script>
    <script src="js/angular/filters/bookstoreFilters.js"></script>
    
    <!-- Custom jQuery -->
    <script src="js/custom/main.js"></script>
</body>
</html>